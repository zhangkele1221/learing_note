## https://juejin.cn/post/7083861498384089101  
### 先看上面的这个链接

**Roaring Bitmap** 是一种高效的数据结构，用于存储和操作大量的整数集合（通常是非负整数）。这种数据结构特别适合于需要快速计算集合间交集、并集、差集等操作的场景，并且在存储和操作大型位图数据时非常节省空间。Roaring Bitmap 在多种数据库和搜索引擎中被广泛应用，例如 Apache Druid 和 Apache Lucene。

### 基本概念

**Bitmap（位图）** 是一种用于表示集合的数据结构，其中用位的开/关状态来表示一个元素是否存在于集合中。例如，在传统的位图中，如果第 i 位是 1，则表示整数 i 在集合中；如果是 0，则表示不在。

### Roaring Bitmap 的结构

Roaring Bitmap 将整数空间划分为多个区间，每个区间包含固定数量的整数（例如，每个区间有 2^16 = 65536 个数字）。根据区间中实际存在的数字的密度，Roaring Bitmap 用三种不同的方式来存储数据：

1. **Bitmap Container**：当一个区间中的数字比较密集时（超过一定的阈值，比如包含的数字超过 4096 个），就使用 Bitmap Container 来存储这个区间。在 Bitmap Container 中，使用 65536 位（或 8192 字节）来直接映射这个区间的所有可能整数。

2. **Array Container**：当一个区间中的数字稀疏时（即数字的数量低于上述阈值），使用数组来存储这些数字。数组中的每个元素直接存储存在于集合中的整数。

3. **Run Container**：对连续的数字序列进行压缩存储。如果一个区间内的数字形成了多个连续的数字序列，那么每个序列可以用一个起始数字和长度来表示，从而节省空间。

### 操作和性能

Roaring Bitmap 提供了快速的集合运算操作，包括：

- **并集（Union）**：合并两个集合中的所有元素。
- **交集（Intersection）**：找出两个集合中共同的元素。
- **差集（Difference）**：从一个集合中去除另一个集合的元素。
- **对称差集（Symmetric Difference）**：找出两个集合中不重叠的部分。
- **基数（Cardinality）**：计算集合中元素的数量。

由于 Roaring Bitmap 的存储方式和算法优化，这些操作通常比传统的 Bitmap 或其他数据结构更快，特别是在处理大规模数据集时。

### 应用场景

Roaring Bitmap 因其出色的性能和空间效率，在很多实际应用中非常受欢迎：

- **数据库索引**：用于快速查询和数据筛选。
- **时间序列数据库**：管理时间序列数据中的时间点。
- **实时分析**：用于实时计算大量数据的统计信息。
- **搜索引擎**：快速处理文档和查询的关系。

### 优点与缺点

**优点**：
- **空间高效**：相比于传统的位图，Roaring Bitmap 在存储稀疏或密集数据集时可以显著减少所需的空间。
- **高性能**：提供快速的集合运算，尤其是在大数据量下。
- **灵活性**：适用于多种不同的数据分布情况，自动选择最优的存储方式。

**缺点**：
- **实现复杂性**：相比简单的数组或标准位图，Roaring Bitmap 的实现更加复杂。
- **维护成本**：优化和维护更加复杂，需要更多的算法支持和优化。

总的来说，Roaring Bitmap 是一种非常实用的数据结构，特别适合于需要快速进行大量集合操作的场景，同时关注存储空间效率。